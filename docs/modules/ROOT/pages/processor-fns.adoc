= Processor Functions

Processor functions can be composed to a pipeline. Each function in a pipeline has to have a unique name. +
If an error occurs during function execution or a validation fails, the unchanged input from the pipeline will be sent to the error topic. The message sent to the error topic will take two headers:

- x-exception-message: The message text of the exception
- x-exception-fqcn: The full qualified classname of the exception

== hasValueValidator
image:hasValueValidator.png[]

If the Json element at the given path does not have a value, an error is emitted. +
Having a value means:

- the element exists
- the element value is not null
- for a textual single value: the string is not empty
- for a multivalue: the array contains at least one textual element which is not empty

=== Parameters

|===
|Parameter Name |Type |Required | Description

|name
|String
|Yes
|The name of the function instance

|elementPath
|https://www.rfc-editor.org/rfc/rfc6901[Json Pointer]
|Yes
|The Pointer to the element to be checked
|===

=== Example
==== Configuration
image:hasValueValidator.png[]

==== Valid Input (single value)
[source, json]
----
{
  "id": "ID_1"
}
----

==== Valid Input (multivalue)
[source, json]
----
{
  "id": [null, "ID_X"]
}
----

==== Invalid Input (element does not exist)
[source, json]
----
{
  "name": "Without id"
}
----

==== Invalid Input (null value)
[source, json]
----
{
  "id": null
}
----

==== Invalid Input (empty string)
[source, json]
----
{
  "id": ""
}
----

==== Invalid Input (multivalue with no non empty string)
[source, json]
----
{
  "id": [null, ""]
}
----

== trimNormalizer
image:trimNormalizer.png[]

== padNormalizer
image:padNormalizer.png[]

== Match
image:Match.png[]

image:fromInput.png[]

image:literal.png[]

The `Match` function reads a message, could extract some parameters from the Json content of the message,  run an OpenSearch search template with extracted parameters against an index, and creates a matched message with this schema:

[source, json]
----
{
  "input": { /* Input Json content */ },
  "matches": [ /* List of Matched entities */ ]
}
----

=== Parameters
[cols="1,1,1,a", options="autowidth"]
|===
|Parameter Name |Type |Required | Description

|name
|String
|Yes
|The name of the function instance

|index
|String
|Yes
|The name of the OpenSearch index

|template
|String
|Yes
|The name of the OpenSearch search template

|paramsFromInput
|Map
|No
|The `paramsFromInput` is a Map between a String and a https://www.rfc-editor.org/rfc/rfc6901[Json Pointer]. The `Match` function extracts elements of the input message from the given path and creates a parameter for running the search template query by the key and the extracted element.

Notes: The search template should require these parameters and values.

A sample:

* key: `ids`
* Value: `/id`
* That means the `Match` function extracts the Json element from the `/id` path, and creates a search parameter with the `ids` key and value of the Json content of the extracted path.

|literalParams
|Map
|No
|The `literalParams` is a Map between a String and a String. The `Match` function creates a search parameter for running the search template by the key and the value.

Notes: The search template should require these parameters and values.

A sample:

* key: `field`
* Value: `id`
* That means the `Match` function creates a search parameter with the `field` key and value of `id`

|===

=== Example
==== Configuration
image:Match-Configured.png[]

----
Function configuration:
    index: testindex
    template: testtemplate
    paramsFromInput: [
        Key: ids, Value: /id
    ]
    literalParams: [
        Key: field, Value: id
    ]
----

===== Search Template Sample:
[source, json]
----
{
  "script": {
    "lang": "mustache",
    "source": "{\"query\":{\"terms\":{\"{{field}}\":{{#toJson}}ids{{/toJson}}}}}"
  }
}
----

===== Sample output of `Match` function
[source, json]
----
{
  "input": {
    "id": "1235",
    "name": "sample-info"
  },
  "matches": [
    {
      "source": {
        "id": "1235",
        "name": "claas"
      },
      "id": "lghKxZYBh3Hgc5n0WdDk",
      "score": 0.18232156
    },
    {
      "source": {
        "id": "1235",
        "name": "sabine"
      },
      "id": "lwhNxZYBh3Hgc5n0mdA7",
      "score": 0.18232156
    }
  ]
}
----

== Reduce2One
image:reduce2One.png[]

== MergeCreate
image:MergeCreate.png[]

image:mapping.png[]

== ChangeEventEmit
image:ChangeEventEmit.png[]

== Multiple Functions
image:multipleFns.png[]

